<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>一覧/追加</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='database_styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='jquery-ui.min.css') }}">
    <script src="{{ url_for('static', filename='jquery-3.7.1.min.js') }}"></script>
    <script src="{{ url_for('static', filename='jquery-ui.min.js') }}"></script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="#" class="navbar-brand">一覧/追加</a>
            <ul class="navbar-menu">
                <li><a href="{{ url_for('index') }}">Home</a></li>
                <li><a href="{{ url_for('database_list') }}">Database</a></li>
                <li><a href="#">その他</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="form-container">
            <h1>診療報酬登録</h1>
            <form id="record-form">
                <input type="hidden" id="record-id" name="record-id">
                <label for="name">名称:</label>
                <input type="text" id="name" name="name"><br>
                <label for="category">分類:</label>
                <select id="category" name="category">
                    <option value="照射方法">照射方法</option>
                    <option value="加算">加算</option>
                    <option value="管理">管理</option>
                </select><br>
                <label for="point">点数:</label>
                <input type="number" id="point" name="point"><br>
                <button type="submit">Save</button>
            </form>
        </div>

        <div class="table-container">
            <h2>診療報酬一覧</h2>
            <div class="filter-container">
                <label for="filter-category">Filter by Category:</label>
                <select id="filter-category">
                    <option value="">All</option>
                    <option value="照射方法">照射方法</option>
                    <option value="加算">加算</option>
                    <option value="管理">管理</option>
                </select>
                <label for="filter-name">Filter by Name:</label>
                <input type="text" id="filter-name" placeholder="Enter name">
                <button id="filter-button">Filter</button>
                <button id="reset-button">Reset</button>
            </div>
            <table id="records-table" border="1">
                <thead>
                    <tr>
                        <th class="th-name">名称</th>
                        <th class="th-category">分類</th>
                        <th class="th-point">点数</th>
                        <th class="th-update_time">最終更新日時</th>
                        <th class="th-action">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            function loadRecords(filters = {}) {
                $.get('/api/records', function(data) {
                    let filteredData = data;

                    if (filters.name) {
                        filteredData = filteredData.filter(record => record[1].toLowerCase().includes(filters.name.toLowerCase()));
                    }

                    if (filters.category) {
                        filteredData = filteredData.filter(record => record[2] === filters.category);
                    }

                    $('#records-table tbody').empty();
                    filteredData.forEach(record => {
                        $('#records-table tbody').append(`
                            <tr data-id="${record[0]}">
                                <td>${record[1]}</td>
                                <td>${record[2]}</td>
                                <td>${record[3]}</td>
                                <td>${record[4]}</td>
                                <td>
                                    <button class="edit" data-id="${record[0]}" data-name="${record[1]}" data-category="${record[2]}" data-point="${record[3]}" data-update_time="${record[4]}">Edit</button>
                                    <button class="delete" data-id="${record[0]}">Delete</button>
                                </td>
                            </tr>
                        `);
                    });

                    // Make the table rows sortable
                    $("#records-table tbody").sortable({
                        update: function(event, ui) {
                            // Get the updated order of IDs
                            var order = $(this).sortable('toArray', { attribute: 'data-id' });
                            
                            // Update IDs based on the new order
                            $(this).find('tr').each(function(index) {
                                $(this).attr('data-id', order[index]);
                            });

                            // Save the updated order
                            $.ajax({
                                url: '/api/reorder',
                                method: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({ order: order }),
                                success: function() {
                                    loadRecords(filters); // Reload records after reordering
                                }
                            });
                        }
                    }).disableSelection();
                });
            }

            loadRecords();

            $('#record-form').on('submit', function(event) {
                event.preventDefault();
                const recordId = $('#record-id').val();
                const record = {
                    name: $('#name').val(),
                    category: $('#category').val(),
                    point: $('#point').val(),
                    //update_time: $('#update_time').val()
                };
                if (recordId) {
                    $.ajax({
                        url: `/api/records/${recordId}`,
                        method: 'PUT',
                        contentType: 'application/json',
                        data: JSON.stringify(record),
                        success: function() {
                            loadRecords();
                            $('#record-form')[0].reset();
                            $('#record-id').val('');
                        }
                    });
                } else {
                    $.ajax({
                        url: '/api/records',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(record),
                        success: function() {
                            loadRecords();
                            $('#record-form')[0].reset();
                        }
                    });
                }
            });

            $(document).on('click', '.edit', function() {
                const id = $(this).data('id');
                const name = $(this).data('name');
                const category = $(this).data('category');
                const point = $(this).data('point');
                //const update_time = $(this).data('update_time');

                $('#record-id').val(id);
                $('#name').val(name);
                $('#category').val(category);
                $('#point').val(point);
                //$('#update_time').val(update_time);
            });

            $(document).on('click', '.delete', function() {
                const id = $(this).data('id');
                $.ajax({
                    url: `/api/records/${id}`,
                    method: 'DELETE',
                    success: function() {
                        loadRecords();
                    }
                });
            });

            $('#filter-button').on('click', function() {
                const category = $('#filter-category').val();
                const name = $('#filter-name').val();
                const filters = { category, name };
                loadRecords(filters);
            });

            $('#reset-button').on('click', function() {
                $('#filter-category').val('');
                $('#filter-name').val('');
                loadRecords();
            });
        });
    </script>
</body>
</html>
